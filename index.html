<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DH BRABO GAMER | ASSINATURAS</title>

<meta name="description" content="Compre assinaturas com estilo no DH BRABO GAMER! Catálogo moderno com partículas e loja de assinaturas." />
<meta name="author" content="DH BRABO GAMER" />
<meta name="theme-color" content="#000000" />
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
/* Estilos Anteriores (sem alterações)... */
* { margin: 0; padding: 0; box-sizing: border-box; }
body, html {
  height: 100%;
  background: #000;
  font-family: 'Bebas Neue', cursive, sans-serif;
  color: rgba(30, 255, 0, 0.5);
  overflow-x: hidden;
  position: relative;
  z-index: 1;
}
body.modal-open {
    overflow: hidden;
}
#particles-js { position: fixed; width: 100%; height: 100%; background: #000; top: 0; left: 0; z-index: 0; }
.container { position: relative; z-index: 1; max-width: 720px; margin: 30px auto; background: rgba(0,0,0,0.15); border-radius: 20px; padding: 30px 35px; box-shadow: 0 0 40px #00ff00aa; backdrop-filter: blur(12px); border: 2px solid #00ff00cc; }
header { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; line-height: 1; }
.logo-circular { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 2px solid #00ff00cc; box-shadow: 0 0 15px #00ff00aa; display: block; flex-shrink: 0; }
h1 { font-size: 40px; color: #aaffaa; text-shadow: 0 0 5px #0f0, 0 0 12px #00ff0099; user-select: none; }
.verificado-badge-img {
  width: 22px;
  height: 22px;
}
input[type="search"] {
  width: 100%;
  max-width: 450px;
  font-size: 18px;
  padding: 14px 18px 14px 50px;
  margin-bottom: 25px;
  border-radius: 12px;
  border: none;
  background: #001100cc;
  color: #00ff00cc;
  box-shadow: inset 0 0 10px #00ff0040, 0 0 15px #00ff0040;
  outline: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300ff0099'%3E%3Cpath d='M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: left 15px center;
  background-size: 24px 24px;
}
input[type="search"]::placeholder { color: #ffffff66; }
input[type="search"]:focus { box-shadow: inset 0 0 20px #00b7ffe5, 0 0 25px #00ff00cc; }
#main-countdown-timer {
  text-align: center;
  margin: -10px 0 25px 0;
  font-size: 22px;
  color: #ffc107;
  text-shadow: 0 0 8px #ffc10788;
}
#main-countdown-timer span {
  font-size: 16px;
  color: #ffffffaa;
  display: block;
}
.section-title { color:rgba(21, 255, 0, 0.356); margin-bottom:15px; user-select:none; text-shadow: 0 0 10px #00ff00; }
.subscriptions, .faq { margin-top: 40px; padding-top: 20px; border-top: 2px solid #004400cc; }
.subscription-item { display: flex; align-items: center; gap: 15px; background: rgba(0, 51, 0, 0.4); border-radius: 15px; padding: 12px 20px; margin-bottom: 16px; box-shadow: 0 0 15px #00ff0088; transition: all 0.3s ease; cursor: default; }
.subscription-item:hover { background: rgba(0, 102, 0, 0.6); }
.sub-logo { width: 50px; height: auto; object-fit: contain; filter: drop-shadow(0 0 3px #00ff00cc); flex-shrink: 0; }
.sub-info { display: flex; align-items: center; flex-grow: 1; color: #aaffaa; cursor: pointer;}
h3 { font-size: 22px; margin-bottom: 5px; color: #aaffaa; text-shadow: 0 0 6px #00ff0088, 0 0 10px #00ff00bb; }
p { font-size: 14px; color: #88cc88aa; line-height: 1.3; }
.add-to-cart-btn {
  font-family: 'Bebas Neue', cursive;
  font-weight: 700;
  font-size: 16px;
  color: #00ff00cc;
  background: #003300cc;
  padding: 8px 18px;
  border-radius: 25px;
  cursor: pointer;
  box-shadow: 0 0 10px #00ff00cc;
  user-select: none;
  text-decoration: none;
  transition: all 0.3s ease;
  border: none;
  white-space: nowrap;
}
.add-to-cart-btn:hover {
  background: #005500cc;
  box-shadow: 0 0 20px #00ff00cc;
  transform: scale(1.05);
}
.add-to-cart-btn.in-cart {
  background: #004500cc;
  box-shadow: 0 0 15px #00ff00cc;
}
.add-to-cart-btn.in-cart:hover {
    background: #006600cc;
}
.add-to-cart-btn .fa-check { margin-right: 5px; }
.faq details { background: rgba(0, 30, 0, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 10px; border: 1px solid #004400cc; }
.faq summary { font-size: 18px; cursor: pointer; color: #aaffaa; }
.faq summary:hover { color: #00ff00; }
.faq p { margin-top: 10px; color: #ccffccbb; }
.faq p strong { color: #00ff00; }
.faq p small { color: #ffaaaa; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; }
.modal-content { background: #050a05; border: 2px solid #00ff00cc; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 0 50px #00ff00aa; position: relative; }
.modal-close { position: absolute; top: 15px; right: 20px; font-size: 30px; color: #0f0; cursor: pointer; border: none; background: none; text-shadow: 0 0 10px #0f0; }
#modal-title { margin-bottom: 15px; }
#modal-body p { margin-bottom: 10px; font-size: 16px; }
#modal-body strong { color: #00ff40; }
#modal-body small { color: #ffaaaa; }
#terms-modal .modal-content {
    max-width: 600px;
}
#terms-text {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
    padding-right: 15px;
    color: #ccffccbb;
    font-size: 15px;
    font-family: sans-serif;
    line-height: 1.5;
}
#terms-text h4 {
    color: #aaffaa;
    margin-top: 15px;
    margin-bottom: 5px;
    font-family: 'Bebas Neue', cursive;
    font-size: 20px;
}
#terms-text p {
    font-size: 14px;
    color: #ccffccbb;
}
#accept-terms-btn {
    width: 100%;
    margin-top: 10px;
    background: #005500cc;
    color: #fff;
    border: none;
    padding: 15px;
    font-size: 18px;
    font-family: 'Bebas Neue', cursive;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}
#accept-terms-btn:hover {
    background: #007700cc;
    box-shadow: 0 0 15px #00ff0088;
}
footer { margin-top: 35px; padding-top: 20px; text-align: center; font-size: 15px; color: #005500cc; text-shadow: 0 0 8px #00ff0066; user-select: none; }
#cart-button {
  position: fixed;
  top: 25px;
  right: 25px;
  width: 50px;
  height: 50px;
  background: #001100cc;
  border: 1px solid #00ff0040;
  color: #00ff00cc;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 20px;
  cursor: pointer;
  z-index: 999;
  box-shadow: 0 0 15px #00ff0040;
  transition: all 0.3s ease;
}
#cart-button:hover {
  transform: scale(1.1);
  box-shadow: 0 0 25px #00ff0088;
}
#cart-count {
  position: absolute;
  top: -5px;
  right: -5px;
  background: red;
  color: white;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  font-size: 14px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: sans-serif;
  font-weight: bold;
  transform: scale(0);
  transition: transform 0.2s ease;
}
#cart-count.visible {
  transform: scale(1);
}
#cart-modal .modal-content {
  max-width: 600px;
}
#cart-items-list {
  max-height: 250px;
  overflow-y: auto;
  margin-bottom: 20px;
  padding-right: 10px;
}
.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #004400cc;
}
.cart-item-info {
  color: #aaffaa;
}
.cart-item-name {
  font-size: 18px;
}
.cart-item-price {
  font-size: 14px;
  color: #88cc88aa;
}
.remove-from-cart-btn {
  background: none;
  border: none;
  color: #ff4444;
  font-size: 20px;
  cursor: pointer;
  transition: color 0.3s ease;
}
.remove-from-cart-btn:hover {
  color: #ff8888;
}
.coupon-area, .credit-area {
    display: flex;
    margin-top: 15px;
    margin-bottom: 5px;
    gap: 10px;
}
#coupon-input, #credit-code-input {
    flex-grow: 1;
    background: #001100cc;
    border: 1px solid #004400cc;
    border-radius: 8px;
    color: #aaffaa;
    padding: 10px;
    font-family: 'Bebas Neue', cursive;
    font-size: 16px;
    outline: none;
}
#coupon-input::placeholder, #credit-code-input::placeholder { color: #ffffff66; }
#apply-coupon-btn, #redeem-credit-btn {
    font-family: 'Bebas Neue', cursive;
    font-weight: 700;
    font-size: 16px;
    color: #00ff00cc;
    background: #003300cc;
    padding: 0 20px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
}
#apply-coupon-btn:hover, #redeem-credit-btn:hover {
    background: #005500cc;
    box-shadow: 0 0 10px #00ff0088;
}
#coupon-feedback {
    font-family: sans-serif;
    font-size: 13px;
    font-weight: bold;
    height: 16px;
    margin-bottom: 10px;
    text-align: right;
    color: #00ff00cc;
}
#cart-summary hr {
    border: 0;
    border-top: 1px solid #00440055;
    margin: 8px 0;
}
#cart-total {
    text-align: right;
    font-size: 18px;
    margin-top: 10px;
    color: #aaffaa;
    line-height: 1.6;
}
#cart-total .final-price {
    font-size: 24px;
    color: #00ff00cc;
    text-shadow: 0 0 8px #00ff0088;
}
#checkout-btn {
  width: 100%;
  margin-top: 20px;
  background: #005500cc;
  color: #fff;
  border: none;
  padding: 15px;
  font-size: 18px;
  font-family: 'Bebas Neue', cursive;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}
#checkout-btn:hover {
  background: #007700cc;
  box-shadow: 0 0 15px #00ff0088;
}
#checkout-btn:disabled {
    background: #333;
    color: #777;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
}
#toast-notification {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: #050a05dd;
    backdrop-filter: blur(5px);
    color: #aaffaa;
    border-radius: 12px;
    border: 2px solid #00ff00cc;
    box-shadow: 0 0 25px #00ff00aa;
    z-index: 2000;
    font-family: sans-serif;
    transition: all 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    opacity: 1;
    display: flex;
    align-items: center;
    padding: 12px 18px;
}
#toast-notification.hidden {
    opacity: 0;
    transform: translateY(120%);
    pointer-events: none;
}
.toast-icon {
    font-size: 24px;
    color: #00ff00;
    margin-right: 15px;
    text-shadow: 0 0 10px #00ff0088;
}
.toast-sender {
    font-size: 12px;
    font-weight: bold;
    color: #88cc88aa;
}
.toast-message {
    font-size: 15px;
}
.toast-message strong {
    color: #fff;
    font-weight: bold;
    background: #00ff0044;
    padding: 2px 6px;
    border-radius: 5px;
}
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
@media (max-width: 720px) {
  .container { margin-left: 10px; margin-right: 10px; }
  .subscription-item { flex-direction: column; align-items: stretch; }
  .add-to-cart-btn { margin-top: 10px; }
  #toast-notification, #referral-box {
      left: 10px;
      right: 10px;
      width: auto;
  }
  #referral-box {
      flex-direction: column;
      text-align: center;
  }
  #referral-box .fas {
      margin-right: 0;
      margin-bottom: 15px;
  }
}
</style>
</head>
<body>
<div id="particles-js" aria-hidden="true"></div>
<div id="toast-notification" class="hidden">
    <i class="fas fa-gift toast-icon"></i>
    <div class="toast-content">
        <div class="toast-sender">ADM Marcos Santos</div>
        <div class="toast-message">Cupom de lançamento <strong>BRABO10</strong>! Válido por tempo limitado.</div>
    </div>
</div>

<div id="terms-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="section-title">Termos de Uso e Serviço</h2>
        <div id="terms-text">
            <h4>1. Sobre o Serviço</h4>
            <p>Bem-vindo ao DH BRABO STREAMING. Oferecemos acesso a contas compartilhadas de serviços de streaming. Ao continuar, você concorda que o serviço principal é um agendamento de compra, a ser finalizada via WhatsApp na data de lançamento: <strong>21 de Junho de 2025</strong>.</p>
            <h4>2. Regras da Conta Compartilhada</h4>
            <p>Para garantir a qualidade do serviço para todos, é fundamental seguir as regras abaixo. O descumprimento de qualquer uma delas resultará na <strong>perda imediata do acesso e da garantia</strong>, sem direito a reembolso.</p>
            <p>
                <strong>1. É PROIBIDO</strong> alterar o e-mail ou a senha da conta fornecida.<br>
                <strong>2. É PROIBIDO</strong> criar novos perfis ou alterar o nome dos perfis existentes.<br>
                <strong>3. É PROIBIDO</strong> colocar senha (PIN) de acesso no seu perfil.<br>
                <strong>4. UTILIZE APENAS</strong> o perfil designado a você. Não acesse ou modifique o perfil de outros usuários.
            </p>
            <h4>3. Pagamento e Garantia</h4>
            <p>O pagamento será processado via <strong>PIX</strong> durante o atendimento no WhatsApp. Oferecemos garantia de acesso durante todo o período contratado. Em caso de problemas, nosso suporte via WhatsApp estará disponível para ajudar.</p>
            <p style="margin-top: 20px;">Ao clicar em "Aceitar e Continuar", você confirma que leu, compreendeu e concorda com todos os termos e condições aqui descritos.</p>
        </div>
        <button id="accept-terms-btn">Aceitar e Continuar</button>
    </div>
</div>

<div id="cart-button" onclick="toggleCartModal()">
  <i class="fas fa-shopping-cart"></i>
  <span id="cart-count">0</span>
</div>

<div id="cart-modal" class="modal-overlay" onclick="toggleCartModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="toggleCartModal()">×</button>
    <h2 class="section-title">Seu Carrinho de Agendamento</h2>
    <div id="cart-items-list"></div>
    <div id="cart-summary">
        <div class="coupon-area">
            <input type="text" id="coupon-input" placeholder="Cupom de desconto" autocomplete="off">
            <button id="apply-coupon-btn" onclick="applyCoupon()">Aplicar</button>
        </div>
        <div id="coupon-feedback"></div>
        <div id="cart-total">
          Subtotal: <span id="cart-subtotal-price">R$ 0,00</span><br>
          <span id="balance-used-row">Saldo Utilizado: <span id="cart-balance-price">R$ 0,00</span><br></span>
          Desconto (Cupom): <span id="cart-discount-price">R$ 0,00</span>
          <hr>
          Total: <span id="cart-total-price" class="final-price">R$ 0,00</span>
        </div>
    </div>
    <button id="checkout-btn" onclick="checkout()">Finalizar via WhatsApp</button>
  </div>
</div>

<div id="itemModal" class="modal-overlay" onclick="closeModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()">×</button>
    <h2 id="modal-title" class="section-title"></h2>
    <div id="modal-body"></div>
  </div>
</div>

<div class="container" role="main">
  <header>
    <img src="https://i.ibb.co/20WtrQj0/logo.png" alt="Logo DH Brabo Gamer" class="logo-circular" />
    <h1>DH BRABO STREAMING</h1>
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" alt="Selo de Verificado" class="verificado-badge-img" title="Verificado">
  </header>
  <input type="search" id="searchInput" placeholder="Pesquisar assinaturas..." oninput="buscarItens(this.value)" autocomplete="off" aria-label="Pesquisar"/>
  <div id="main-countdown-timer"></div>
  <section class="subscriptions" aria-label="Loja de assinaturas">
    <h2 class="section-title">Agende sua Assinatura</h2>
    <div id="subscriptionsList" aria-live="polite" aria-atomic="true"></div>
  </section>
  <section class="faq" aria-label="Perguntas Frequentes">
      <h2 class="section-title">Perguntas Frequentes</h2>
      <details>
          <summary>Como funciona o agendamento?</summary>
          <p>Você já pode escolher suas assinaturas e adicioná-las ao carrinho para garantir seu lugar. No dia do lançamento (21/06), o botão para finalizar a compra será liberado e você poderá concluir seu pedido via WhatsApp.</p>
      </details>
      <details>
          <summary>É seguro? Qual a garantia?</summary>
          <p>Sim, totalmente seguro. Oferecemos garantia durante todo o período da assinatura. Caso tenha qualquer problema com o acesso, basta nos contatar no WhatsApp para suporte imediato.</p>
      </details>
      <details>
          <summary>Quais são as formas de pagamento?</summary>
          <p>No momento, aceitamos pagamentos via PIX. A chave será informada durante o atendimento no WhatsApp no dia do lançamento.</p>
      </details>
      <details>
          <summary>Quais são as regras das contas compartilhadas?</summary>
          <p><strong>É fundamental seguir as regras para não perder o acesso:</strong><br><br>
              1. É proibido alterar o e-mail ou a senha da conta.<br>
              2. Não é permitido criar novos perfis ou colocar senha (PIN) no seu.<br>
              3. Utilize apenas o seu perfil. Não mexa nos perfis de outros usuários.<br><br>
              <small>O descumprimento de qualquer regra resulta na perda total da garantia.</small>
          </p>
      </details>
  </section>

  <section class="faq" aria-label="Programa de Indicação">
    <h2 class="section-title">Indique um Amigo e Ganhe!</h2>
    <div id="referral-box" style="background: rgba(0, 30, 0, 0.3); border-radius: 10px; padding: 25px; border: 1px solid #004400cc;">
        <div style="display: flex; align-items: center; text-align: left;">
            <i class="fas fa-users" style="font-size: 40px; color: #00ff00; margin-right: 25px; text-shadow: 0 0 10px #00ff0088;"></i>
            <div>
                <h3 style="font-size: 24px; margin-bottom: 10px;">Ganhe R$ 5,00 de Saldo!</h3>
                <p style="font-size: 16px; color: #ccffccbb; line-height: 1.5; font-family: sans-serif;">
                Gostou do nosso serviço? Indique para um amigo! Quando ele fizer a primeira compra e mencionar você, te enviaremos um <strong>código de crédito</strong> no WhatsApp para você resgatar seu saldo aqui.
                </p>
            </div>
        </div>
        <div class="credit-area" style="margin-top: 20px;">
            <input type="text" id="credit-code-input" placeholder="Insira seu código de crédito aqui">
            <button id="redeem-credit-btn" onclick="redeemCreditCode()">Resgatar</button>
        </div>
        <div id="balance-display" style="font-family: sans-serif; font-size: 18px; color: #00ff00; text-align: center; margin-top: 15px; text-shadow: 0 0 8px #00ff0088;">Seu saldo: R$ 0,00</div>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 DH BRABO GAMER. Todos os direitos reservados.</p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script>
  // --- SCRIPT PRINCIPAL COM NOVA LÓGICA DE VALIDAÇÃO ---

  const assinaturas = [
      { id: 'sub1', tipo: 'assinatura', nome: "Netflix", preco: "21,90", icone: "https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg", detalhes: { 'Qualidade': 'Full HD (1080p)', 'Telas': '1 tela por vez', 'Tipo': 'Conta compartilhada' } },
      { id: 'sub2', tipo: 'assinatura', nome: "HBO Max", preco: "18,90", icone: "https://upload.wikimedia.org/wikipedia/commons/1/17/HBO_Max_Logo.svg", detalhes: { 'Qualidade': 'Full HD (1080p)', 'Telas': '1 tela por vez', 'Tipo': 'Conta compartilhada' } },
      { id: 'sub3', tipo: 'assinatura', nome: "Youcine", preco: "13,00", icone: "https://i.ibb.co/whkcVZFF/channels4-profile.jpg", detalhes: { 'Qualidade': '4K Ultra HD', 'Telas': 'Múltiplas telas', 'Tipo': 'Conta Privada' } },
      { id: 'sub4', tipo: 'assinatura', nome: "Amazon Prime", preco: "9,90", icone: "https://i.ibb.co/rR4BgfRP/images.jpg", detalhes: { 'Qualidade': 'Full HD (1080p)', 'Telas': '1 tela por vez', 'Tipo': 'Conta compartilhada' } }
  ];
  const coupons = { 'BRABO10': { type: 'percentage', value: 0.10 } };
  
  // --- NOVA LISTA SECRETA DE CÓDIGOS DE CRÉDITO ---
  const validCreditCodes = [
    '8B4F2K', 'R9G3J7', 'C1P6H5', 'X7V2M9', 'T4E8N1', 'L6S3D', 'Q2Z9W4', 'Y5F1K8', 
    'G7J6T2', 'V3N5P9', 'A8C2L6', 'M1H7S4', 'D6K9R3', 'W4T8X1', 'Z5B2N7', 'F9J3C5',
    'P7G6K', 'S2R4M9', 'U8V1H4', 'E6L5T7', 'K3W8Q2', 'N9X4Z1', 'H5D7B3', 'J1M6C8',
    'B4R9G5', 'G2P3S7', 'T9F1V4', 'Y8C6H2', 'L5K8W3', 'Q4N7X9'
  ];

  let appliedCoupon = null;
  let cart = [];
  
  const itemModal = document.getElementById('itemModal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const subsList = document.getElementById("subscriptionsList");
  const cartButton = document.getElementById('cart-button');
  const cartCount = document.getElementById('cart-count');
  const cartModal = document.getElementById('cart-modal');
  const cartItemsList = document.getElementById('cart-items-list');
  const cartSubtotalPrice = document.getElementById('cart-subtotal-price');
  const cartDiscountPrice = document.getElementById('cart-discount-price');
  const couponFeedback = document.getElementById('coupon-feedback');
  const termsModal = document.getElementById('terms-modal');
  const acceptTermsBtn = document.getElementById('accept-terms-btn');
  const balanceDisplay = document.getElementById('balance-display');
  const cartBalancePrice = document.getElementById('cart-balance-price');
  const balanceUsedRow = document.getElementById('balance-used-row');

  // --- FUNÇÕES DE SALDO COM VALIDAÇÃO SEGURA ---
  function initializeBalance() {
    let balance = parseFloat(localStorage.getItem('userBalance')) || 0;
    localStorage.setItem('userBalance', balance.toFixed(2));
    updateBalanceDisplay();
  }

  function updateBalanceDisplay() {
    let balance = parseFloat(localStorage.getItem('userBalance')) || 0;
    if (balanceDisplay) {
        balanceDisplay.textContent = `Seu saldo: R$ ${balance.toFixed(2).replace('.', ',')}`;
    }
  }

  function redeemCreditCode() {
    const input = document.getElementById('credit-code-input');
    const code = input.value.trim().toUpperCase();
    
    // Nova Lógica de Validação
    const isCodeValid = validCreditCodes.includes(code);
    const isCodeUsed = localStorage.getItem('used_credit_' + code) === 'true';

    if (isCodeValid && !isCodeUsed) {
        let balance = parseFloat(localStorage.getItem('userBalance')) || 0;
        balance += 5.00;
        localStorage.setItem('userBalance', balance.toFixed(2));
        localStorage.setItem('used_credit_' + code, 'true'); // Marca o código como usado

        updateBalanceDisplay();
        alert('Crédito de R$ 5,00 resgatado com sucesso!');
        input.value = '';
    } else {
        alert('Código de crédito inválido ou já utilizado.');
    }
  }

  function addToCart(subId) {
    const isAlreadyInCart = cart.find(item => item.id === subId);
    if (isAlreadyInCart) {
        if (!confirm("Este item já está no carrinho. Deseja adicioná-lo novamente?")) { return; }
    }
    const subToAdd = assinaturas.find(sub => sub.id === subId);
    if (subToAdd) {
      const newItem = { ...subToAdd, cartItemId: Date.now() + Math.random() };
      cart.push(newItem);
      updateCartUI();
      updateAddToCartButtons();
    }
  }

  function removeFromCart(cartItemId) {
    cart = cart.filter(item => item.cartItemId !== cartItemId);
    updateCartUI();
    updateAddToCartButtons();
  }

  function applyCoupon() {
    const input = document.getElementById('coupon-input');
    const code = input.value.trim().toUpperCase();
    const couponAlreadyUsed = localStorage.getItem('couponUsed_BRABO10') === 'true';

    if (code === 'BRABO10' && !couponAlreadyUsed) {
        if (cart.length === 0) {
            couponFeedback.style.color = '#ff4444';
            couponFeedback.textContent = 'Adicione itens ao carrinho primeiro.';
            return;
        }
        appliedCoupon = { code: code, ...coupons[code] };
        couponFeedback.style.color = '#00ff00cc';
        couponFeedback.textContent = 'Cupom aplicado com sucesso!';
    } else {
        appliedCoupon = null;
        couponFeedback.style.color = '#ff4444';
        couponFeedback.textContent = 'Cupom inválido ou já utilizado.';
    }
    input.value = '';
    updateCartUI();
  }

  function updateCartUI() {
    if (cart.length > 0) {
      cartCount.textContent = cart.length;
      cartCount.classList.add('visible');
    } else {
      cartCount.classList.remove('visible');
    }

    cartItemsList.innerHTML = '';
    if (cart.length === 0) {
        cartItemsList.innerHTML = '<p>Seu carrinho de agendamento está vazio.</p>';
        appliedCoupon = null;
    } else {
        cart.forEach(item => {
        const itemHTML = `<div class="cart-item"><div class="cart-item-info"><div class="cart-item-name">${item.nome}</div><div class="cart-item-price">R$ ${item.preco}</div></div><button class="remove-from-cart-btn" onclick="removeFromCart(${item.cartItemId})" title="Remover item">×</button></div>`;
        cartItemsList.innerHTML += itemHTML;
        });
    }

    const subtotal = cart.reduce((sum, item) => sum + parseFloat(item.preco.replace(',', '.')), 0);
    let couponDiscount = 0;

    if (appliedCoupon && subtotal > 0) {
        if (appliedCoupon.type === 'percentage') {
            couponDiscount = subtotal * appliedCoupon.value;
        }
    }

    let remainingTotal = subtotal - couponDiscount;
    let availableBalance = parseFloat(localStorage.getItem('userBalance')) || 0;
    let balanceUsed = 0;

    if (availableBalance > 0 && remainingTotal > 0) {
        balanceUsed = Math.min(remainingTotal, availableBalance);
        balanceUsedRow.style.display = 'block';
    } else {
        balanceUsedRow.style.display = 'none';
    }
    
    const total = remainingTotal - balanceUsed;
    
    cartSubtotalPrice.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
    cartBalancePrice.textContent = `- R$ ${balanceUsed.toFixed(2).replace('.', ',')}`;
    cartDiscountPrice.textContent = `- R$ ${couponDiscount.toFixed(2).replace('.', ',')}`;
    document.getElementById('cart-total-price').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
  }
  
  function updateAddToCartButtons() {
    const allBtns = document.querySelectorAll('.add-to-cart-btn');
    allBtns.forEach(btn => {
        const subId = btn.dataset.subId;
        if (cart.find(item => item.id === subId)) {
            btn.innerHTML = `<i class="fas fa-check"></i> Agendado`;
            btn.classList.add('in-cart');
        } else {
            btn.innerHTML = `Agendar`;
            btn.classList.remove('in-cart');
        }
    });
  }
  
  function checkout() {
    if (cart.length === 0) {
        alert("Seu carrinho está vazio!");
        return;
    }

    const subtotal = cart.reduce((sum, item) => sum + parseFloat(item.preco.replace(',', '.')), 0);
    let couponDiscount = (appliedCoupon) ? subtotal * appliedCoupon.value : 0;
    let remainingTotal = subtotal - couponDiscount;
    let availableBalance = parseFloat(localStorage.getItem('userBalance')) || 0;
    let balanceUsed = Math.min(remainingTotal, availableBalance);
    
    if (balanceUsed > 0) {
        let newBalance = availableBalance - balanceUsed;
        localStorage.setItem('userBalance', newBalance.toFixed(2));
        updateBalanceDisplay();
    }

    if (appliedCoupon && appliedCoupon.code === 'BRABO10') {
        localStorage.setItem('couponUsed_BRABO10', 'true');
    }

    let mensagem = "Olá! Tenho interesse em finalizar meu agendamento com as seguintes assinaturas:\n\n";
    cart.forEach(item => { mensagem += `- ${item.nome} (R$ ${item.preco})\n`; });

    mensagem += `\n*Subtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}*`;
    if (balanceUsed > 0) {
        mensagem += `\n*Saldo Utilizado: -R$ ${balanceUsed.toFixed(2).replace('.', ',')}*`;
    }
    if (couponDiscount > 0) {
        mensagem += `\n*Desconto (Cupom): -R$ ${couponDiscount.toFixed(2).replace('.', ',')}*`;
    }
    const total = subtotal - couponDiscount - balanceUsed;
    mensagem += `\n\n*Total a pagar: R$ ${total.toFixed(2).replace('.', ',')}*`;

    const whatsappLink = `https://wa.me/5581991822689?text=${encodeURIComponent(mensagem)}`;
    window.open(whatsappLink, '_blank');
  }

  function toggleCartModal() {
    const isOpen = cartModal.style.display === 'flex';
    cartModal.style.display = isOpen ? 'none' : 'flex';
    document.body.classList.toggle('modal-open', !isOpen);
    if (!isOpen) { updateCartUI(); }
  }
  
  function openModal(itemId) {
      const item = assinaturas.find(i => i.id === itemId);
      if (!item) return;
      modalTitle.textContent = item.nome;
      let detailsHTML = `<p>Assinatura mensal por R$ ${item.preco}</p><hr style="border-color:#004400cc; margin:10px 0;">`;
      for (const [key, value] of Object.entries(item.detalhes)) { detailsHTML += `<p><strong>${key}:</strong> ${value}</p>`; }
      detailsHTML += `<p style="margin-top:15px; color: #ffc107; text-shadow: 0 0 8px #ffc10788; font-family: sans-serif; font-weight: bold;">VAGAS LIMITADAS! Garanta a sua antes que esgote.</p>`;
      if (item.detalhes && item.detalhes.Tipo === 'Contas compartilhadas') {
          detailsHTML += `<hr style="border-color:#004400cc; margin:15px 0;"><p><strong>REGRAS DA CONTA:</strong></p><p style="font-size:13px; line-height:1.4;">1. Proibido alterar e-mail ou senha.<br>2. Proibido colocar PIN no seu perfil.<br>3. Use apenas o seu perfil.<br><small>O descumprimento anula a garantia.</small></p>`;
      }
      modalBody.innerHTML = detailsHTML;
      itemModal.style.display = 'flex';
      document.body.classList.add('modal-open');
  }

  function closeModal() {
      itemModal.style.display = 'none';
      document.body.classList.remove('modal-open');
  }
  
  function mostrarAssinaturas(lista) {
      subsList.innerHTML = "";
      if (lista.length === 0) { subsList.innerHTML = "<p style='text-align:center;'>Nenhuma assinatura encontrada com esse termo.</p>"; }
      lista.forEach((sub, i) => {
          const subHTML = `<article class="subscription-item" style="--delay:${i * 0.1}s"><div class="sub-info" onclick="openModal('${sub.id}')"><img src="${sub.icone}" alt="Logo ${sub.nome}" class="sub-logo" loading="lazy"/><div style="margin-left: 15px;"><h3>${sub.nome}</h3><p>Assinatura mensal - R$ ${sub.preco}</p></div></div><button class="add-to-cart-btn" data-sub-id="${sub.id}" onclick="addToCart('${sub.id}')">Agendar</button></article>`;
          subsList.insertAdjacentHTML("beforeend", subHTML);
      });
      updateAddToCartButtons();
  }

  function buscarItens(texto) {
    const filtro = texto.toLowerCase();
    const subsFiltradas = assinaturas.filter(s => s.nome.toLowerCase().includes(filtro));
    mostrarAssinaturas(subsFiltradas);
  }
  
  function initializeLaunchCountdown() {
    const checkoutBtn = document.getElementById('checkout-btn');
    const mainCountdownDisplay = document.getElementById('main-countdown-timer');
    const targetDate = new Date('2025-06-21T00:00:00').getTime();
    const countdownInterval = setInterval(() => {
        const now = new Date().getTime();
        const distance = targetDate - now;
        if (distance <= 0) {
            clearInterval(countdownInterval);
            mainCountdownDisplay.style.display = 'none';
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = 'Finalizar via WhatsApp';
        } else {
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);
            mainCountdownDisplay.innerHTML = `<span>Lançamento da loja em:</span> ${d}d ${h}h ${m}m ${s}s`;
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = `Libera em ${new Date(targetDate).toLocaleDateString()}`;
        }
    }, 1000);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
      const toast = document.getElementById('toast-notification');
      if (toast) {
          setTimeout(() => { toast.classList.remove('hidden'); }, 2000);
          setTimeout(() => { toast.classList.add('hidden'); }, 10000);
      }
      if (!localStorage.getItem('termsAccepted')) {
          termsModal.style.display = 'flex';
          document.body.classList.add('modal-open');
      }
      initializeBalance();
      mostrarAssinaturas(assinaturas);
      initializeLaunchCountdown();
      particlesJS("particles-js", {
          particles: { number: { value: 150, density: { enable: true, value_area: 700 } }, color: { value: "#00ff00" }, shape: { type: "circle" }, opacity: { value: 0.35, anim: { enable: true, speed: 1.2, opacity_min: 0.15, sync: false } }, size: { value: 3, random: true, anim: { enable: true, speed: 4, size_min: 1, sync: false } }, line_linked: { enable: true, distance: 120, color: "#00ff00", opacity: 0.18, width: 1 }, move: { enable: true, speed: 2, direction: "none", random: true, straight: false, out_mode: "out", bounce: false } }, interactivity: { detect_on: "canvas", events: { onhover: { enable: false, mode: "" }, onclick: { enable: false, mode: "" }, resize: true } }, retina_detect: true 
      });
  });
  acceptTermsBtn.addEventListener('click', () => {
      termsModal.style.display = 'none';
      localStorage.setItem('termsAccepted', 'true');
      document.body.classList.remove('modal-open');
  });
</script>
</body>
</html>
